- job:
    block-downstream: false
    block-upstream: false
    builders:
        - shell: |
            #!/bin/bash

            set -x
            #local copy of build scripts
            if [ ! -d local ]; then
                mkdir -p local
                (cd local; git clone https://github.com/open-estuary/ci-scripts.git -b openlab2.0)
            fi

            (cd local/ci-scripts; git pull)
            export PATH=${WORKSPACE}/local/ci-scripts/jenkins-helper-script/common/lava-ci:${PATH}
            export IMAGEPATH="$(find /var/www/images/kernel-ci/plinth -printf '%T+ %p\n' | sort -r | grep -E ".*plinth-[0-9].[0-9]*.[0-9].{,5}.*/arm64-defconfig.*d05-config/Image" |head -n1)"

            if [ ! -n "$IMAGEPATH" ]; then
                exit 1
            fi

            URLPATH=${IMAGEPATH#*kernel-ci/plinth/}
            URLPATH=${URLPATH%I*}

            cd local/ci-scripts/jenkins-helper-script/common/lava-ci
            rm -rf jobs
            lava-kernel-ci-job-creator.py http://localhost:8083/plinth/$URLPATH --plans weekly-testing --targets hip06-d03 hip07-d05
            cd jobs
            lava-job-runner.py --username default --token g43y0wtyi0m2ua7in3xtfch1m2s1dd0k97ac1fqqhqd0qblimtehqkwk8mjimsyh0jczrnaibdlb23mtn17qca6i14tcl27h7md580za5p8w81fl035b6bk1ybw26lle --server http://localhost:8089/RPC2/ --stream /anonymous/plinth/ --poll POLL
            cd ..
            rm -rf jobs

    - shell: |
        wget https://raw.githubusercontent.com/ariya/phantomjs/master/examples/rasterize.js
        phantomjs rasterize.js http://localhost:8089/dashboard/image-charts/Plinth report.jpg 1920px
    concurrent: false
    description: <!-- Managed by Jenkins Job Builder -->
    disabled: false
    name: plinth-daily-testing
    parameters: []
    project-type: freestyle
    properties:
    - build-discarder:
        artifact-days-to-keep: -1
        artifact-num-to-keep: -1
        days-to-keep: 30
        num-to-keep: 30
    publishers:
    - email-ext:
        attach-build-log: false
        attachment: report.jpg
        body: "The enclosed is a summary image report.<br>\nPlease check the detail\
          \ at: <a href=\"http://124.250.134.52:800/dashboard/image-charts/Plinth\"\
          > Plinth LAVA Image Report</a><br>\n\u2500<br>\nFor more info write to \"\
          xuwei5@hisilicon.com\"  <br>\n"
        content-type: text/html
        recipients: gabriele.paoloni@huawei.com, charles.chenxin@huawei.com, huangdaode@hisilicon.com,
          xavier.huwei@huawei.com, wangzhou1@hisilicon.com, xuwei5@hisilicon.com,
          liwenchang@hisilicon.com, tangchaofei@huawei.com, wanghuiqiang@huawei.com,
          xuzaibo@huawei.com, yuanzhichang@hisilicon.com, yisen.zhuang@huawei.com,
          zhangjukuo@huawei.com, john.garry@huawei.com, shiju.jose@huawei.com, dongyingjie@hisilicon.com,
          linyunsheng@huawei.com, salil.mehta@huawei.com,yankejian@huawei.com,liudongdong3@huawei.com,lipeng321@huawei.com,
          cc:yimin@huawei.com, cc:liguozhu@hisilicon.com, cc:zhaojunhua@hisilicon.com,
          cc:lixiaoping3@huawei.com, cc:z.liuxinliang@hisilicon.com, cc:kong.kongxinwei@hisilicon.com,
          cc:shameerali.kolothum.thodi@huawei.com, cc:sanil.kumar@hisilicon.com, cc:wangkefeng.wang@huawei.com,
          cc:guohanjun@huawei.com, cc:ting.lei@hisilicon.com, cc:liao.heng@hisilicon.com,
          cc:zhouxiping@hisilicon.com, cc:zhouxufeng@huawei.com, cc:haifeng.wei@huawei.com,
          cc:chengchuanning@hisilicon.com, cc:zhanweitao@hisilicon.com, cc:jeffrey.wu@hisilicon.com,
          cc:yaohongshi@hisilicon.com, cc:fengyuming@hisilicon.com, cc:zhengqiang10@huawei.com,
          cc:tanxiaofei@huawei.com, cc:lijingyu@hisilicon.com, cc:ningguoqiang@huawei.com,
          cc:lisheng011@huawei.com, cc:wangyuanxiang1@huawei.com, cc:lipeng321@huawei.com
        reply-to: null
        subject: '[Plinth]Daily Release Image Testing Report'
    triggers:
    - timed: H 3 * * *
    wrappers:
    - timestamps
