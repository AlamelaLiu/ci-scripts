- job:
    name: kernelci-kboot-bot
    project-type: freestyle
    defaults: global
    logrotate:
        daysToKeep: 30
        numToKeep: 30
    properties:
        - authorization:
            anonymous:
                - job-read
                - job-extended-read
    disabled: false
    display-name: 'kernel ci - lava bot'
    parameters:
        - string:
           default: 'plinth'
           description: ''
           name: TREE_NAME
        - string:
           default: ''
           description: ''
           name: GIT_DESCRIBE
        - string:
           default: 'arm64'
           description: ''
           name: ARCH
    wrappers:
        - timestamps
    builders:
    - shell: |
        #!/bin/bash
        set -x

        # local copy of build scripts
        if [ ! -d local ]; then
          mkdir -p local
          (cd local; git clone https://github.com/open-estuary/ci-scripts.git -b openlab2.0)
        fi

        (cd local/ci-scripts; git pull)
        export PATH=${WORKSPACE}/local/ci-scripts/jenkins-helper-script/common/lava-ci:${PATH}

        if [ ${ARCH} = "arm64" ]; then
          #PWD=$(pwd)
          cd local/ci-scripts/jenkins-helper-script/common/lava-ci
          rm -rf jobs
          lava-kernel-ci-job-creator.py http://localhost:8083/${TREE_NAME}/${GIT_DESCRIBE}/${ARCH}-defconfig/ --plans boot --targets hip05-d02
          cd jobs
          lava-job-runner.py --username default --token g43y0wtyi0m2ua7in3xtfch1m2s1dd0k97ac1fqqhqd0qblimtehqkwk8mjimsyh0jczrnaibdlb23mtn17qca6i14tcl27h7md580za5p8w81fl035b6bk1ybw26lle --server http://localhost:8089/RPC2/ --stream /anonymous/plinth/ --poll POLL
          cd ..
          lava-report.py --boot jobs/results/POLL --lab openlab2 --api http://localhost:8888/ --token 41a59aba-c663-4742-87fc-8558e3a1391b
          
          cd local/ci-scripts/jenkins-helper-script/common/lava-ci
          rm -rf jobs
          lava-kernel-ci-job-creator.py http://localhost:8083/${TREE_NAME}/${GIT_DESCRIBE}/${ARCH}-defconfig/ --plans boot --targets hip06-d03
          cd jobs
          lava-job-runner.py --username default --token g43y0wtyi0m2ua7in3xtfch1m2s1dd0k97ac1fqqhqd0qblimtehqkwk8mjimsyh0jczrnaibdlb23mtn17qca6i14tcl27h7md580za5p8w81fl035b6bk1ybw26lle --server http://localhost:8089/RPC2/ --stream /anonymous/plinth/ --poll POLL
          cd ..
          lava-report.py --boot jobs/results/POLL --lab openlab2 --api http://localhost:8888/ --token 41a59aba-c663-4742-87fc-8558e3a1391b
          rm -rf jobs
        fi
